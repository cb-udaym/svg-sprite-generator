<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="favicon.ico" />
  <title>Icon Gallery</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; background-color: #f7f7f7;}
    header { display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content: space-between; }
    input { padding:10px 12px; border:1px solid #ddd; border-radius:10px; min-width:100%; }
    h2 { margin:24px 0 10px; font-size:14px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(300px,1fr)); gap:12px; }
    .card { border:1px solid #eee; border-radius:14px; padding:12px; display:flex; gap:10px; background-color: white;}
    .iconBox { width:50px; height:50px; border:1px solid #f0f0f0; border-radius:12px; display:grid; place-items:center; }
    .iconBox svg { width:30px; height:30px; }
    .name { font-weight:600; font-size:13px;display: flex; align-items: center; gap: 4px; }
    .code { font-family: ui-monospace; font-size:12px; color:#333; margin-top:4px; word-break:break-word; display: none; }
    button { margin-top:8px; margin-right:8px; border:1px solid #ddd; background:#fff; padding:4px 10px; border-radius:6px; cursor:pointer; font-size:10px; }
    .toast { position:fixed; bottom:18px; left:50%; transform:translateX(-50%); background:#111; color:#fff; padding:10px 12px; border-radius:12px; opacity:0; transition:.2s; pointer-events:none; }
    .toast.show { opacity:1; }
    @media (max-width: 880px) {
        header {
            flex-direction: column;
            align-items: flex-start;
        }
    }
    .modal { position: fixed; inset: 0; display: none; z-index: 9999; }
  .modal.is-open { display: block; }
  .modal__backdrop { position: absolute; inset: 0; background: rgba(0,0,0,.45); }
  .modal__panel {
    position: relative;
    width: min(900px, calc(100vw - 32px));
    max-height: calc(100vh - 32px);
    margin: 16px auto;
    background: #fff;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0,0,0,.2);
    display: flex;
    flex-direction: column;
  }
  .modal__header { padding: 14px 16px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #eee; }
  .modal__header h2 { margin:0; font-size:16px; }
  .modal__close { border:0 solid #ddd; background:#fff; border-radius:10px; padding:6px 10px; cursor:pointer; }
  .modal__body { padding: 16px; overflow: auto; }
  /* Basic markdown styling */
  .modal__body h1, .modal__body h2, .modal__body h3 { margin: 16px 0 8px; }
  .modal__body p { margin: 8px 0; line-height: 1.5; }
  .modal__body code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas; background:#f6f6f6; padding:2px 4px; border-radius:6px; }
  .modal__body pre { background:#f6f6f6; padding:12px; border-radius:12px; overflow:auto; }
  .modal__body a { color: #0b57d0; }
  .modal__body ul { padding-left: 20px; }
  </style>
</head>
<body>
<header style="display: flex;justify-content: space-between;">
    <div id="meta" style="color:#666;font-size:13px;flex: 1 1 0%;"></div>
    <div style="flex: 1 1 0%;">
        <h1 style="margin:0;font-size:18px;display: none;">Icons</h1>
        <input id="search" placeholder="Search icons…" />
    </div>
    <div style="flex: 1 1 0%;display: flex;align-items: center;justify-content: end;gap: 8px;">
        <button id="downloadSprite" style="font-size: 16px;font-weight: 500;margin:0;padding: 8px 16px;;">Download latest sprite</button>
        <svg id="infoBtn" style="cursor: pointer;" width="18" height="18" aria-hidden="true"><use href="sprite/sprite.svg#info"></use></svg>
    </div>
</header>
<hr style="border: .5px solid #e6e6e6;margin-top: 20px;">
<div id="app"></div>
<div class="toast" id="toast"></div>

<!-- Modal -->
<div id="infoModal" class="modal" aria-hidden="true">
  <div class="modal__backdrop" data-close="1"></div>

  <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="infoTitle">
    <div class="modal__header">
      <h2 id="infoTitle">Guidelines for SVG sprites</h2>
      <button class="modal__close" onclick="closeModal()" type="button" data-close="1" aria-label="Close"><svg width="12" height="12" aria-hidden="true"><use href="sprite/sprite.svg#close"></use></svg></button>
    </div>

    <div id="infoBody" class="modal__body">
      Loading…
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
  const app = document.getElementById("app");
  const meta = document.getElementById("meta");
  const toast = document.getElementById("toast");
  const search = document.getElementById("search");

  let data, q = "";

  function snippet(name) {
    return `<svg class="" aria-hidden="true"><use href="${data.spritePath}#${name}"></use></svg>`;
  }

  function showToast(text) {
    toast.textContent = text;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 900);
  }

  async function copy(text, label) {
    try {
      await navigator.clipboard.writeText(text);
      showToast(label);
    } catch {
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      showToast(label);
    }
  }

  function groupByDate(icons) {
    const m = new Map();
    for (const i of icons) {
      const d = i.addedDate || "Unknown";
      if (!m.has(d)) m.set(d, []);
      m.get(d).push(i);
    }
    return [...m.entries()].sort((a,b) => b[0].localeCompare(a[0]));
  }

  function escapeHtml(s) {
    return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  function render() {
    const icons = data.icons.filter(i => i.name.toLowerCase().includes(q));
    const grouped = groupByDate(icons);

    app.innerHTML = grouped.map(([date, arr]) => `
      <section>
        <h2>${formatDate(date)} <span style="color:#888;font-weight:400">(${arr.length})</span></h2>
        <div class="grid">
          ${arr.map(i => `
            <div class="card">
              <div class="iconBox">
                <svg aria-hidden="true"><use href="${data.spritePath}#${i.name}"></use></svg>
              </div>
              <div style="min-width:0">
                <div class="name">${i.name} 
                    <svg aria-hidden="true" style="width: 14px;height: 14px;cursor:pointer;color: #646464;" data-copy-name="${i.name}"><use href="sprite/sprite.svg#copy"></use></svg>
                    </div>
                <div class="code">${escapeHtml(snippet(i.name))}</div>
                <div>
                  <button data-copy-snippet="${i.name}">Copy &lt;use&gt;</button>
                </div>
              </div>
            </div>
          `).join("")}
        </div>
      </section>
    `).join("");

    app.querySelectorAll("[data-copy-name]").forEach(b =>
      b.onclick = () => copy(b.dataset.copyName, "Icon name copied")
    );
    app.querySelectorAll("[data-copy-snippet]").forEach(b =>
      b.onclick = () => copy(snippet(b.dataset.copySnippet), "<use> snippet copied")
    );
  }

  (async function init() {
    const res = await fetch("sprite/icons.json");
    data = await res.json();
    meta.textContent = `Total: ${data.icons.length} • Generated: ${new Date(data.generatedAt).toLocaleString()}`;
    render();
  })();

  search.addEventListener("input", e => { q = e.target.value.trim().toLowerCase(); render(); });

  function formatDate(isoDate) {
  const d = new Date(isoDate);

  const day = d.getDate();
  const suffix =
    day % 10 === 1 && day !== 11 ? "st" :
    day % 10 === 2 && day !== 12 ? "nd" :
    day % 10 === 3 && day !== 13 ? "rd" :
    "th";

  const monthYear = d.toLocaleDateString("en-GB", {
    month: "short",
    year: "numeric"
  });

  return `${day}${suffix} ${monthYear}`;
}

document.getElementById("downloadSprite").addEventListener("click", async () => {
  const response = await fetch("sprite/sprite.svg");
  const svgText = await response.text();

  const blob = new Blob([svgText], { type: "image/svg+xml" });
  const url = URL.createObjectURL(blob);

  const epoch = Date.now(); // milliseconds

  const a = document.createElement("a");
  a.href = url;
  a.download = `sprite-${epoch}.svg`;
  document.body.appendChild(a);
  a.click();

  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});


</script>

<script>
  const modal = document.getElementById("infoModal");
  const infoBtn = document.getElementById("infoBtn");
  const body = document.getElementById("infoBody");

  function openModal() {
    modal.classList.add("is-open");
    modal.setAttribute("aria-hidden", "false");
    document.addEventListener("keydown", onKeydown);
  }

  function closeModal() {
    modal.classList.remove("is-open");
    modal.setAttribute("aria-hidden", "true");
    document.removeEventListener("keydown", onKeydown);
  }

  function onKeydown(e) {
    if (e.key === "Escape") closeModal();
  }

  async function loadReadme() {
    body.textContent = "Loading…";
    try {
      // adjust path if needed: "../readme.md" etc.
      const res = await fetch("modal.md", { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const md = await res.text();
      body.innerHTML = marked.parse(md);
    } catch (err) {
      body.innerHTML = `<p>Could not load <code>modal.md</code>.</p><pre>${String(err)}</pre>`;
    }
  }

  infoBtn.addEventListener("click", async () => {
    openModal();
    await loadReadme();
  });

  modal.addEventListener("click", (e) => {
    if (e.target?.dataset?.close) closeModal();
  });
</script>

</body>
</html>
